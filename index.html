<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <title>血常规仪表盘（增强版）</title>
  <script src="chart.min.js"></script>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:24px;color:#222}
    h1{font-size:20px;margin:0 0 12px}
    section{margin-top:24px}
    canvas{max-width:100%;width:100%;height:auto;touch-action:pan-y;}
    table{border-collapse:collapse;width:100%;margin-top:8px;font-size:13px}
    th,td{border:1px solid #ddd;padding:6px;text-align:center}
    th{background:#fafafa}
    tr:nth-child(even){background:#fcfcfc}
    .ok{background:#eaf7ea}
    .hi{background:#ffe6e6}
    .lo{background:#e6f0ff}
    .legend{font-size:12px;color:#666;margin-top:6px}
    .metric-title{margin:12px 0 6px;font-weight:600}
    #controls{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;margin:12px 0 8px}
    #controls .box{border:1px solid #e3e3e3;border-radius:6px;padding:8px 10px}
    #controls label{margin-right:10px;display:inline-flex;align-items:center;gap:4px}
    select,input[type="checkbox"]{padding:4px 6px;font-size:13px}
    .small{font-size:12px;color:#666;margin-top:6px}
    button{padding:4px 8px;border:1px solid #ccc;background:#fafafa;border-radius:4px;margin-right:6px;cursor:pointer}
    button:hover{background:#f0f0f0}
    pre,code{white-space:pre-wrap;word-break:break-word;font-family:Menlo,"SF Mono",Consolas,"PingFang SC","Microsoft YaHei",monospace}

    /* Mobile & Tablet adjustments */
    @media (max-width: 768px){
      body{margin:12px;font-size:14px}
      h1{font-size:18px}
      #controls{gap:12px}
      #controls .box{padding:8px}
      select{font-size:14px;padding:6px}
      button{font-size:14px;padding:6px 10px}
      table{font-size:12px}
      .metric-title{font-size:14px}
      /* fixed canvas height to ensure visibility on mobile */
      canvas.chart-canvas{height:240px}
    }
    @media (min-width: 769px){
      canvas.chart-canvas{height:320px}
    }

    /* Device mode overrides */
    body[data-mode="mobile"]{margin:12px;font-size:14px}
    body[data-mode="mobile"] h1{font-size:18px}
    body[data-mode="mobile"] #controls{gap:12px}
    body[data-mode="mobile"] #controls .box{padding:8px}
    body[data-mode="mobile"] select{font-size:14px;padding:6px}
    body[data-mode="mobile"] button{font-size:14px;padding:6px 10px}
    body[data-mode="mobile"] table{font-size:12px}
    body[data-mode="mobile"] .metric-title{font-size:14px}
    body[data-mode="mobile"] canvas.chart-canvas{height:240px}

    body[data-mode="tablet"]{margin:16px;font-size:15px}
    body[data-mode="tablet"] h1{font-size:19px}
    body[data-mode="tablet"] #controls{gap:14px}
    body[data-mode="tablet"] canvas.chart-canvas{height:300px}

    body[data-mode="desktop"]{margin:24px;font-size:16px}
    body[data-mode="desktop"] h1{font-size:20px}
    body[data-mode="desktop"] canvas.chart-canvas{height:360px}
  </style>
</head>
<body>
  <h1>血常规仪表盘（增强版：筛选、区间、趋势线）</h1>
  <div class="legend">着色：绿色=正常，红色=高，蓝色=低；可勾选指标、选择日期区间并叠加趋势线</div>
  <div id="controls"></div>
  <section id="charts"></section>
  <section id="table"></section>

  <script>
    // 基础数据（已内置，无需网络请求）
    const dates = [
      "2025-08-06","2025-08-12","2025-08-28","2025-09-02",
      "2025-09-18","2025-09-23","2025-10-09","2025-10-14"
    ];

    const metrics = [
      {name:"红细胞",unit:"10^12/L",low:3.8,high:5.1,vals:[4.07,3.92,3.32,3.21,3.12,3.48,2.78,2.69]},
      {name:"红细胞压积",unit:"%",low:35,high:45,vals:[37.2,35.3,30.7,30.0,29.1,32.2,26.9,26.4]},
      {name:"血红蛋白浓度",unit:"g/L",low:115,high:150,vals:[120.0,118.0,101.0,98.0,93.0,105.7,85.2,85.5]},
      {name:"平均红细胞体积",unit:"fL",low:82,high:100,vals:[91.4,90.1,92.5,93.5,93.0,93.0,97.0,98.0]},
      {name:"平均血红蛋白含量",unit:"pg",low:27,high:34,vals:[29.5,30.1,30.4,30.5,29.8,30.4,30.7,31.9]},
      {name:"平均血红蛋白浓度",unit:"g/L",low:316,high:354,vals:[323.0,334.0,329.0,327.0,319.3,328.0,316.1,327.0]},
      {name:"红细胞分布宽度变异系数",unit:"%",low:10,high:15,vals:[13.6,12.3,13.1,14.1,12.7,13.5,13.8,14.2]},
      {name:"红细胞分布宽度标准差",unit:"fL",low:37,high:50,vals:[44.4,40.4,40.6,44.1,null,null,null,null]},
      {name:"白细胞",unit:"10^9/L",low:3.5,high:9.5,vals:[7.4,18.6,4.8,18.4,6.69,22.4,7.28,13.96]},
      {name:"淋巴细胞百分数",unit:"%",low:20,high:50,vals:[27.1,6.6,20.0,4.1,16.2,4.7,13.5,8.0]},
      {name:"淋巴细胞计数",unit:"10^9/L",low:1.1,high:3.2,vals:[1.99,1.2,1.0,0.8,1.08,1.05,0.98,1.12]},
      {name:"中性粒细胞百分数",unit:"%",low:40,high:75,vals:[63.1,91.8,72.5,94.0,76.2,89.6,80.1,85.2]},
      {name:"中性粒细胞计数",unit:"10^9/L",low:1.8,high:6.3,vals:[4.64,17.0,3.5,17.3,5.1,20.1,5.83,11.9]},
      {name:"单核细胞百分数",unit:"%",low:3,high:10,vals:[7.9,0.7,7.1,1.4,6.5,1.4,5.3,6.3]},
      {name:"单核细胞计数",unit:"10^9/L",low:0.1,high:0.6,vals:[0.58,0.13,0.34,0.25,0.44,0.31,0.39,0.86]},
      {name:"嗜酸性粒细胞百分数",unit:"%",low:0.4,high:8,vals:[1.6,0.4,0.2,0.3,1.0,4.2,0.9,0.4]},
      {name:"嗜酸性粒细胞计数",unit:"10^9/L",low:0.02,high:0.52,vals:[0.12,0.07,0.01,0.06,0.07,0.94,0.07,0.06]},
      {name:"嗜碱性粒细胞百分数",unit:"%",low:0.0,high:1.0,vals:[0.3,0.5,0.2,0.2,0.1,0.1,0.2,0.1]},
      {name:"嗜碱性粒细胞计数",unit:"10^9/L",low:0.0,high:0.06,vals:[0.02,0.1,0.01,0.04,0.03,0.01,0.01,0.01]},
      {name:"幼稚粒细胞百分比",unit:"%",low:null,high:null,vals:[0.1,8.0,0.6,5.6,null,null,null,null]},
      {name:"幼稚粒细胞",unit:"10^3/UL",low:null,high:null,vals:[null,3.49,0.03,2.14,null,0.2,0.06,0.04]},
      {name:"不典型淋巴细胞百分比",unit:"%",low:0.0,high:2.0,vals:[null,null,0.4,0.1,0.1,0.1,null,null]},
      {name:"不典型淋巴细胞绝对数",unit:"",low:0.0,high:0.2,vals:[null,null,0.01,0.02,0.01,0.01,null,null]},
      {name:"巨大不成熟细胞百分比",unit:"%",low:0.0,high:2.0,vals:[null,null,0.6,1.8,0.8,0.3,null,null]},
      {name:"巨大未成熟细胞绝对值",unit:"",low:0.0,high:0.2,vals:[null,null,0.04,0.2,0.06,0.04,null,null]},
      {name:"血小板计数",unit:"10^9/L",low:125,high:350,vals:[228.0,132.0,166.0,145.0,115.0,152.0,78.0,75.0]},
      {name:"血小板体积分布宽度",unit:"fL",low:9,high:17,vals:[12.8,14.5,11.7,13.3,14.0,14.8,16.0,17.0]},
      {name:"平均血小板体积",unit:"fL",low:9,high:13,vals:[10.5,11.6,10.8,11.1,7.8,8.3,8.2,8.5]},
      {name:"血小板压积",unit:"%",low:0.11,high:0.28,vals:[0.24,0.15,0.18,0.16,0.09,0.126,0.064,0.064]},
      {name:"大血小板比率",unit:"%",low:13,high:43,vals:[22.6,39.4,30.3,34.0,null,null,null,null]},
      {name:"有核红细胞计数",unit:"10^3/UL",low:null,high:null,vals:[null,0.0,0.0,0.01,null,null,0.01,0.01]},
      {name:"有核红细胞百分比",unit:"%",low:null,high:null,vals:[0.0,0.0,0.0,0.1,null,null,0.1,0.1]}
    ];

    const defaultSelected = [
      "血红蛋白浓度","白细胞","中性粒细胞计数","血小板计数","红细胞","红细胞压积"
    ];

    function classify(v, low, high){
      if(v==null || isNaN(v) || low==null || high==null) return "";
      if(v < low) return "lo";
      if(v > high) return "hi";
      return "ok";
    }

    function regression(xs, ys){
      const data = xs.map((x,i)=>({x, y:ys[i]})).filter(p=>p.y!=null && !isNaN(p.y));
      const n = data.length;
      if(n < 2) return null;
      const sumX = data.reduce((s,p)=>s+p.x,0), sumY = data.reduce((s,p)=>s+p.y,0);
      const meanX = sumX/n, meanY = sumY/n;
      let num=0, den=0;
      data.forEach(p=>{ num += (p.x-meanX)*(p.y-meanY); den += (p.x-meanX)*(p.x-meanX); });
      if(den === 0) return null;
      const slope = num/den;
      const intercept = meanY - slope*meanX;
      return {slope, intercept};
    }

    function buildControls(){
      const wrap = document.getElementById("controls");
      wrap.innerHTML = "";

      const box1 = document.createElement("div");
      box1.className = "box";
      box1.innerHTML = "<div style='font-weight:600;margin-bottom:6px'>选择指标</div>";
      metrics.forEach(m=>{
        const lab = document.createElement("label");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.value = m.name;
        cb.checked = defaultSelected.includes(m.name);
        cb.addEventListener("change", updateView);
        lab.appendChild(cb);
        lab.appendChild(document.createTextNode(" "+m.name));
        box1.appendChild(lab);
      });
      wrap.appendChild(box1);

      const box2 = document.createElement("div");
      box2.className = "box";
      box2.innerHTML = "<div style='font-weight:600;margin-bottom:6px'>日期区间</div>";
      const startSel = document.createElement("select");
      startSel.id = "startSel";
      const endSel = document.createElement("select");
      endSel.id = "endSel";
      dates.forEach((d,i)=>{
        const o1 = document.createElement("option"); o1.value = i; o1.textContent = d; startSel.appendChild(o1);
        const o2 = document.createElement("option"); o2.value = i; o2.textContent = d; endSel.appendChild(o2);
      });
      startSel.value = 0;
      endSel.value = String(dates.length-1);
      startSel.addEventListener("change", ()=>{ if(+startSel.value > +endSel.value) endSel.value = startSel.value; updateView(); });
      endSel.addEventListener("change", ()=>{ if(+endSel.value < +startSel.value) startSel.value = endSel.value; updateView(); });
      box2.appendChild(startSel);
      box2.appendChild(document.createTextNode(" 至 "));
      box2.appendChild(endSel);

      const quick = document.createElement("div");
      quick.className = "small";
      quick.innerHTML = "<div style='margin-top:6px'>快捷：<button id='all'>全部</button><button id='last3'>最近3次</button><button id='last5'>最近5次</button></div>";
      box2.appendChild(quick);
      wrap.appendChild(box2);

      document.getElementById("all").onclick = ()=>{ startSel.value = 0; endSel.value = String(dates.length-1); updateView(); };
      document.getElementById("last3").onclick = ()=>{ startSel.value = String(Math.max(0, dates.length-3)); endSel.value = String(dates.length-1); updateView(); };
      document.getElementById("last5").onclick = ()=>{ startSel.value = String(Math.max(0, dates.length-5)); endSel.value = String(dates.length-1); updateView(); };

      const box3 = document.createElement("div");
      box3.className = "box";
      const lab = document.createElement("label");
      const chk = document.createElement("input");
      chk.type = "checkbox";
      chk.id = "trendToggle";
      chk.addEventListener("change", updateView);
      lab.appendChild(chk);
      lab.appendChild(document.createTextNode(" 显示趋势线"));
      box3.appendChild(lab);
      wrap.appendChild(box3);

      // 设备模式选择
      const box4 = document.createElement("div");
      box4.className = "box";
      box4.innerHTML = "<div style='font-weight:600;margin-bottom:6px'>显示模式</div>";
      const modes = [
        {id:'modeAuto', val:'auto', text:'自动'},
        {id:'modeMobile', val:'mobile', text:'手机'},
        {id:'modeTablet', val:'tablet', text:'Pad'},
        {id:'modeDesktop', val:'desktop', text:'电脑'},
      ];
      modes.forEach(m=>{
        const lab = document.createElement('label');
        const rb = document.createElement('input');
        rb.type = 'radio';
        rb.name = 'mode';
        rb.id = m.id;
        rb.value = m.val;
        rb.addEventListener('change', ()=>applyMode(rb.value));
        lab.appendChild(rb);
        lab.appendChild(document.createTextNode(' '+m.text));
        box4.appendChild(lab);
      });
      wrap.appendChild(box4);
    }

    function subset(arr, start, end){ return arr.slice(start, end+1); }

    function makeChart(ctx, label, vals, low, high, showTrend, start){
      const filtered = vals.map(v=>v).slice(start, start + subset(dates, start, +document.getElementById("endSel").value).length);
      const ds = [{
        label: label,
        data: filtered,
        borderColor: "#1976d2",
        backgroundColor: "rgba(25,118,210,.15)",
        tension: .2,
        spanGaps: true
      }];
      if(showTrend){
        const xs = filtered.map((_,i)=>i);
        const reg = regression(xs, filtered);
        if(reg){
          const trend = xs.map(x=>reg.slope*x + reg.intercept);
          ds.push({ label:"趋势线", data:trend, borderColor:"#d32f2f", borderDash:[6,4], pointRadius:0 });
        }
      }
      return new Chart(ctx, {
        type: "line",
        data: {
          labels: subset(dates, start, +document.getElementById("endSel").value),
          datasets: ds
        },
        options: {
          plugins: { legend: { display:true, position: "bottom" } },
          scales: { x: { ticks: { maxRotation: 0 } }, y: { beginAtZero:false } },
          elements: { point: { radius:3 } },
          responsive: true,
          maintainAspectRatio: false,
          animation: false,
          interaction: { mode: "index", intersect: false },
          devicePixelRatio: window.devicePixelRatio || 1
        }
      });
    }

    function renderCharts(){
      const wrap = document.getElementById("charts");
      wrap.innerHTML = "";
      const start = +document.getElementById("startSel").value;
      const end = +document.getElementById("endSel").value;
      const showTrend = document.getElementById("trendToggle").checked;
      const selected = Array.from(document.querySelectorAll('#controls input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.value);
      selected.forEach(name=>{
        const m = metrics.find(x=>x.name===name);
        if(!m) return;
        const lowText = (m.low !== null && m.low !== undefined) ? m.low : "-";
        const highText = (m.high !== null && m.high !== undefined) ? m.high : "-";
        const h = document.createElement("div");
        h.className = "metric-title";
        h.textContent = `${m.name} (${m.unit}) 参考:${lowText}~${highText}`;
        wrap.appendChild(h);
        const c = document.createElement("canvas");
        c.className = "chart-canvas";
        wrap.appendChild(c);
        makeChart(c.getContext("2d"), m.name, m.vals, m.low, m.high, showTrend, start);
      });
    }

    function renderTable(){
      const start = +document.getElementById("startSel").value;
      const end = +document.getElementById("endSel").value;
      const tblWrap = document.getElementById("table");
      tblWrap.innerHTML = "";
      const tbl = document.createElement("table");
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");
      ["检测指标","单位","标准下限","标准上限", ...subset(dates, start, end)].forEach(t=>{
        const th = document.createElement("th"); th.textContent = t; headRow.appendChild(th);
      });
      thead.appendChild(headRow);
      tbl.appendChild(thead);
      const tbody = document.createElement("tbody");
      metrics.forEach(m=>{
        const tr = document.createElement("tr");
        const lowCell = (m.low !== null && m.low !== undefined) ? m.low : "";
        const highCell = (m.high !== null && m.high !== undefined) ? m.high : "";
        [m.name, m.unit, lowCell, highCell].forEach(t=>{ const td = document.createElement("td"); td.textContent = t; tr.appendChild(td); });
        for(let i=start; i<=end; i++){
          const v = m.vals[i];
          const td = document.createElement("td");
          td.textContent = (v==null ? "" : String(v));
          td.className = classify(v, m.low, m.high);
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);
      tblWrap.appendChild(tbl);
    }

    function updateView(){
      renderCharts();
      renderTable();
    }

    // 初始渲染（为避免未创建控件时报错，创建临时占位元素）
    buildControls();
    initMode();
    // 窄屏与旋转自适应：在尺寸变化时，如为“自动模式”则重新判定并重绘
    function detectMode(){ const w = window.innerWidth; return w<=768 ? 'mobile' : (w<=1024 ? 'tablet' : 'desktop'); }
    function applyMode(mode){
      window.__selectedMode = mode;
      localStorage.setItem('viewMode', mode);
      const actual = (mode === 'auto') ? detectMode() : mode;
      document.body.setAttribute('data-mode', actual);
      setTimeout(updateView, 50);
    }
    function initMode(){
      const saved = localStorage.getItem('viewMode') || 'auto';
      const radios = {
        auto: document.getElementById('modeAuto'),
        mobile: document.getElementById('modeMobile'),
        tablet: document.getElementById('modeTablet'),
        desktop: document.getElementById('modeDesktop'),
      };
      if(radios[saved]) radios[saved].checked = true;
      applyMode(saved);
    }
    window.addEventListener('orientationchange', ()=>{ if((window.__selectedMode||'auto')==='auto'){ applyMode('auto'); } else { setTimeout(updateView,100); } });
    window.addEventListener('resize', ()=>{ clearTimeout(window.__rt); window.__rt = setTimeout(()=>{ if((window.__selectedMode||'auto')==='auto'){ applyMode('auto'); } else { updateView(); } }, 150); });
    const tmpStart = document.createElement('select'); tmpStart.id='startSel'; tmpStart.value=0;
    const tmpEnd = document.createElement('select'); tmpEnd.id='endSel'; tmpEnd.value=dates.length-1;
    const tmpTrend = document.createElement('input'); tmpTrend.id='trendToggle'; tmpTrend.type='checkbox'; tmpTrend.checked=false;
    updateView();
  </script>
</body>
</html>